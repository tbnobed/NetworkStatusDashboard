{% extends "base.html" %}

{% block title %}Dashboard - obtv CDN Monitor{% endblock %}

{% block content %}
<div class="dashboard-header fade-in">
    <div class="d-flex justify-content-between align-items-start">
        <div>
            <h1 class="dashboard-title">
                <i class="fas fa-tachometer-alt me-2"></i>Dashboard
            </h1>
            <p class="dashboard-subtitle">Real-time monitoring of your OBTV CDN infrastructure</p>
        </div>
        <button class="btn btn-outline-primary" onclick="refreshDashboard()">
            <i class="fas fa-sync-alt me-1"></i>Refresh
        </button>
    </div>
</div>

<!-- Summary Cards - Row 1 -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="metric-card metric-primary slide-up clickable-card" onclick="showServersList()">
            <div class="metric-header">
                <h6 class="metric-title">Total Servers</h6>
                <div class="metric-icon icon-primary">
                    <i class="fas fa-server"></i>
                </div>
            </div>
            <div class="metric-value" id="total-servers">{{ stats.total_servers }}</div>
            <div class="metric-change neutral">
                <i class="fas fa-minus"></i>
                Infrastructure
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="metric-card metric-success slide-up clickable-card" onclick="showOnlineServers()">
            <div class="metric-header">
                <h6 class="metric-title">Online</h6>
                <div class="metric-icon icon-success">
                    <i class="fas fa-check-circle"></i>
                </div>
            </div>
            <div class="metric-value" id="online-servers">{{ stats.online_servers }}</div>
            <div class="metric-change positive">
                <i class="fas fa-arrow-up"></i>
                Healthy
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="metric-card metric-danger slide-up clickable-card" onclick="showOfflineServers()">
            <div class="metric-header">
                <h6 class="metric-title">Offline</h6>
                <div class="metric-icon icon-danger">
                    <i class="fas fa-times-circle"></i>
                </div>
            </div>
            <div class="metric-value" id="offline-servers">{{ stats.offline_servers }}</div>
            <div class="metric-change {% if stats.offline_servers > 0 %}negative{% else %}neutral{% endif %}">
                <i class="fas fa-{% if stats.offline_servers > 0 %}exclamation-triangle{% else %}minus{% endif %}"></i>
                {% if stats.offline_servers > 0 %}Server{{ 's' if stats.offline_servers != 1 }} down{% else %}No issues{% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="metric-card metric-info slide-up clickable-card" onclick="showStreamsList()">
            <div class="metric-header">
                <h6 class="metric-title">Total Connections</h6>
                <div class="metric-icon icon-info">
                    <i class="fas fa-users"></i>
                </div>
            </div>
            <div class="metric-value" id="total-connections">{{ stats.total_connections }}</div>
            <div class="metric-change positive">
                <i class="fas fa-arrow-up"></i>
                Active
            </div>
        </div>
    </div>
</div>

<!-- Summary Cards - Row 2 -->
<div class="row mb-5">
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Bandwidth Up</h6>
                        <h3 class="mb-0" id="total-bandwidth-up">{{ "%.1f"|format(stats.total_bandwidth_up or 0) }} Mbps</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-arrow-up fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Bandwidth Down</h6>
                        <h3 class="mb-0" id="total-bandwidth-down">{{ "%.1f"|format(stats.total_bandwidth_down or 0) }} Mbps</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-arrow-down fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Total Streams</h6>
                        <h3 class="mb-0" id="total-streams">{{ stats.total_streams }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-video fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<!-- Charts Row -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0">Server Status Distribution</h5>
            </div>
            <div class="card-body d-flex align-items-center justify-content-center">
                <canvas id="status-chart" style="max-height: 300px; width: 100%;"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0">Connections by Server</h5>
            </div>
            <div class="card-body d-flex align-items-center justify-content-center">
                <canvas id="connections-chart" style="max-height: 300px; width: 100%;"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Bandwidth Chart Row -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Bandwidth Usage by Server</h5>
            </div>
            <div class="card-body">
                <canvas id="bandwidth-chart" style="max-height: 400px;"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Server Grid -->
<div class="row mb-4">
    <div class="col">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Server Overview</h5>
                <div class="d-flex gap-2">
                    <div class="btn-group" role="group" aria-label="View options">
                        <button type="button" class="btn btn-outline-primary btn-sm active" id="card-view-btn" onclick="dashboard.switchView('cards')">
                            <i class="fas fa-th-large me-1"></i>Cards
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-sm" id="table-view-btn" onclick="dashboard.switchView('table')">
                            <i class="fas fa-list me-1"></i>Table
                        </button>
                    </div>
                    <a href="{{ url_for('servers') }}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-cog me-1"></i>Manage Servers
                    </a>
                </div>
            </div>
            <div class="card-body">
                {% if servers %}
                    <div class="row" id="servers-grid">
                        {% for server in servers %}
                            <div class="col-md-6 col-lg-4 mb-4">
                                <div class="server-card slide-up" data-server-id="{{ server.id }}">
                                    <div class="server-header">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="server-title">{{ server.hostname }}</h6>
                                                <div class="server-meta">
                                                    <span class="server-role server-role-{{ server.role }}">
                                                        <i class="fas fa-tag"></i>{{ server.role.title() }}
                                                    </span>
                                                </div>
                                                <div class="server-address">
                                                    <i class="fas fa-network-wired"></i>{{ server.ip_address }}:{{ server.port }}
                                                </div>
                                            </div>
                                            <div class="server-status status-{{ server.status }}">
                                                <i class="fas fa-{{ 'check-circle' if server.status == 'up' else 'times-circle' if server.status == 'down' else 'question-circle' }}"></i>
                                                {{ server.status.upper() }}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="server-metrics">
                                        <div class="row">
                                            <div class="col-4">
                                                <div class="server-metric">
                                                    <div class="server-metric-value" data-metric="connections">0</div>
                                                    <div class="server-metric-label">Connections</div>
                                                </div>
                                            </div>
                                            <div class="col-4">
                                                <div class="server-metric">
                                                    <div class="server-metric-value server-metric-warning" data-metric="stream_count">0</div>
                                                    <div class="server-metric-label">Streams</div>
                                                </div>
                                            </div>
                                            <div class="col-4">
                                                <div class="server-metric">
                                                    <div class="server-metric-value" data-metric="response_time">N/A</div>
                                                    <div class="server-metric-label">Response Time</div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="server-bandwidth">
                                            <div class="row">
                                                <div class="col-6">
                                                    <div class="bandwidth-metric bandwidth-in">
                                                        <div class="bandwidth-value" data-metric="bandwidth_in">
                                                            {% if server.metrics.first() and server.metrics.first().bandwidth_in %}
                                                                {{ "%.2f"|format(server.metrics.first().bandwidth_in) }}
                                                            {% else %}
                                                                0.00
                                                            {% endif %}
                                                        </div>
                                                        <div class="bandwidth-label">
                                                            <i class="fas fa-arrow-down"></i>Mbps
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-6">
                                                    <div class="bandwidth-metric bandwidth-out">
                                                        <div class="bandwidth-value" data-metric="bandwidth_out">
                                                            {% if server.metrics.first() and server.metrics.first().bandwidth_out %}
                                                                {{ "%.2f"|format(server.metrics.first().bandwidth_out) }}
                                                            {% else %}
                                                                0.00
                                                            {% endif %}
                                                        </div>
                                                        <div class="bandwidth-label">
                                                            <i class="fas fa-arrow-up"></i>Mbps
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="server-actions">
                                        <button class="btn-action" onclick="dashboard.showServerDetails({{ server.id }})">
                                            <i class="fas fa-chart-line"></i>
                                            View Details
                                        </button>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Table View -->
                    <div class="table-responsive d-none" id="servers-table">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Server</th>
                                    <th>Status</th>
                                    <th class="d-none d-md-table-cell">Role</th>
                                    <th>Connections</th>
                                    <th>Streams</th>
                                    <th class="d-none d-lg-table-cell">Bandwidth In</th>
                                    <th class="d-none d-lg-table-cell">Bandwidth Out</th>
                                    <th class="d-none d-sm-table-cell">Response Time</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for server in servers %}
                                <tr data-server-id="{{ server.id }}">
                                    <td>
                                        <div>
                                            <strong>{{ server.hostname }}</strong>
                                            <br>
                                            <small class="text-muted">{{ server.ip_address }}:{{ server.port }}</small>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="server-status status-{{ server.status }}">
                                            <i class="fas fa-{{ 'check-circle' if server.status == 'up' else 'times-circle' if server.status == 'down' else 'question-circle' }}"></i>
                                            {{ server.status.upper() }}
                                        </span>
                                    </td>
                                    <td class="d-none d-md-table-cell">
                                        <span class="server-role server-role-{{ server.role }}">
                                            <i class="fas fa-tag"></i>{{ server.role.title() }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="server-metric-value" data-metric="connections">0</span>
                                    </td>
                                    <td>
                                        <span class="server-metric-value server-metric-warning" data-metric="stream_count">0</span>
                                    </td>
                                    <td class="d-none d-lg-table-cell">
                                        <span class="bandwidth-value bandwidth-in" data-metric="bandwidth_in">
                                            {% if server.metrics.first() and server.metrics.first().bandwidth_in %}
                                                {{ "%.2f"|format(server.metrics.first().bandwidth_in) }}
                                            {% else %}
                                                0.00
                                            {% endif %}
                                        </span>
                                        <small class="text-muted"> Mbps</small>
                                    </td>
                                    <td class="d-none d-lg-table-cell">
                                        <span class="bandwidth-value bandwidth-out" data-metric="bandwidth_out">
                                            {% if server.metrics.first() and server.metrics.first().bandwidth_out %}
                                                {{ "%.2f"|format(server.metrics.first().bandwidth_out) }}
                                            {% else %}
                                                0.00
                                            {% endif %}
                                        </span>
                                        <small class="text-muted"> Mbps</small>
                                    </td>
                                    <td class="d-none d-sm-table-cell">
                                        <span class="server-metric-value" data-metric="response_time">N/A</span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" onclick="dashboard.showServerDetails({{ server.id }})">
                                            <i class="fas fa-chart-line"></i>
                                            <span class="d-none d-md-inline">Details</span>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-server fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No servers configured</h5>
                        <p class="text-muted">Add your first server to start monitoring your CDN infrastructure.</p>
                        <a href="{{ url_for('add_server') }}" class="btn btn-primary">
                            <i class="fas fa-plus me-1"></i>Add Server
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Recent Alerts -->
<div class="row">
    <div class="col">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Recent Alerts</h5>
            </div>
            <div class="card-body">
                {% if alerts %}
                    <div class="list-group list-group-flush" id="alerts-list">
                        {% for alert in alerts %}
                            <div class="list-group-item d-flex justify-content-between align-items-start">
                                <div class="ms-2 me-auto">
                                    <div class="fw-bold">
                                        <span class="badge bg-{{ 'danger' if alert.severity == 'critical' else 'warning' if alert.severity == 'warning' else 'info' }} me-2">
                                            {{ alert.severity.upper() }}
                                        </span>
                                        {{ alert.message }}
                                    </div>
                                    <small class="text-muted">
                                        {{ alert.created_at.strftime('%Y-%m-%d %H:%M:%S') }}
                                    </small>
                                </div>
                                <button class="btn btn-sm btn-outline-secondary" onclick="acknowledgeAlert({{ alert.id }})">
                                    <i class="fas fa-check me-1"></i>Acknowledge
                                </button>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                        <p class="text-muted mb-0">No active alerts</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
<!-- Metric Detail Modal -->
<div id="metric-detail-modal" class="metric-detail-modal">
    <div class="metric-detail-content">
        <div class="metric-detail-header">
            <h5 id="metric-detail-title" class="metric-detail-title">Server Details</h5>
            <button class="metric-detail-close" onclick="closeMetricDetail()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="metric-detail-body" class="metric-detail-body">
            <!-- Content will be populated by JavaScript -->
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Initialize charts
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    
    // Auto-refresh every 30 seconds
    setInterval(refreshDashboard, 30000);
});

function initializeCharts() {
    // Status Distribution Chart
    const statusCtx = document.getElementById('status-chart').getContext('2d');
    window.statusChart = new Chart(statusCtx, {
        type: 'doughnut',
        data: {
            labels: ['Online', 'Offline', 'Unknown'],
            datasets: [{
                data: [{{ stats.online_servers }}, {{ stats.offline_servers }}, {{ stats.unknown_servers }}],
                backgroundColor: ['#28a745', '#dc3545', '#6c757d'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    
    // Connections Chart
    const connectionsCtx = document.getElementById('connections-chart').getContext('2d');
    const serverNames = [{% for server in servers %}'{{ server.hostname }}'{% if not loop.last %},{% endif %}{% endfor %}];
    const connectionCounts = [{% for server in servers %}{{ server.metrics.first().active_connections if server.metrics.first() else 0 }}{% if not loop.last %},{% endif %}{% endfor %}];
    
    window.connectionsChart = new Chart(connectionsCtx, {
        type: 'bar',
        data: {
            labels: serverNames,
            datasets: [{
                label: 'Active Connections',
                data: connectionCounts,
                backgroundColor: '#007bff',
                borderColor: '#0056b3',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
    
    // Bandwidth Chart
    const bandwidthCtx = document.getElementById('bandwidth-chart').getContext('2d');
    const bandwidthInData = [{% for server in servers %}{{ server.metrics.first().bandwidth_in if server.metrics.first() and server.metrics.first().bandwidth_in else 0 }}{% if not loop.last %},{% endif %}{% endfor %}];
    const bandwidthOutData = [{% for server in servers %}{{ server.metrics.first().bandwidth_out if server.metrics.first() and server.metrics.first().bandwidth_out else 0 }}{% if not loop.last %},{% endif %}{% endfor %}];
    
    window.bandwidthChart = new Chart(bandwidthCtx, {
        type: 'bar',
        data: {
            labels: serverNames,
            datasets: [{
                label: 'Incoming (Mbps)',
                data: bandwidthInData,
                backgroundColor: '#28a745',
                borderColor: '#1e7e34',
                borderWidth: 1
            }, {
                label: 'Outgoing (Mbps)',
                data: bandwidthOutData,
                backgroundColor: '#007bff',
                borderColor: '#0056b3',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Bandwidth (Mbps)'
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top'
                },
                title: {
                    display: true,
                    text: 'Real-time Bandwidth Usage'
                }
            }
        }
    });
}

function refreshDashboard() {
    // Refresh dashboard data
    fetch('/api/dashboard/stats')
        .then(response => response.json())
        .then(data => {
            // Update summary cards
            document.getElementById('total-servers').textContent = data.total_servers;
            document.getElementById('online-servers').textContent = data.status_counts.up || 0;
            document.getElementById('offline-servers').textContent = data.status_counts.down || 0;
            document.getElementById('total-connections').textContent = data.total_connections;
            
            // Update charts
            if (window.statusChart) {
                window.statusChart.data.datasets[0].data = [
                    data.status_counts.up || 0,
                    data.status_counts.down || 0,
                    data.status_counts.unknown || 0
                ];
                window.statusChart.update();
            }
        })
        .catch(error => {
            console.error('Error refreshing dashboard:', error);
        });
    
    // Refresh server grid
    fetch('/api/servers')
        .then(response => response.json())
        .then(servers => {
            updateServerGrid(servers);
        })
        .catch(error => {
            console.error('Error refreshing servers:', error);
        });
}

function updateServerGrid(servers) {
    const grid = document.getElementById('servers-grid');
    if (!grid) return;
    
    servers.forEach(server => {
        const serverCard = document.querySelector(`[data-server-id="${server.id}"]`);
        if (serverCard) {
            // Update status badge
            const statusBadge = serverCard.querySelector('.badge');
            statusBadge.className = `badge bg-${server.status === 'up' ? 'success' : server.status === 'down' ? 'danger' : 'secondary'}`;
            statusBadge.textContent = server.status.toUpperCase();
            
            // Update metrics
            const connectionsMetric = serverCard.querySelector('[data-metric="connections"]');
            if (connectionsMetric && server.latest_metric) {
                connectionsMetric.textContent = server.latest_metric.active_connections || 0;
            }
            
            const responseTimeMetric = serverCard.querySelector('[data-metric="response_time"]');
            if (responseTimeMetric && server.latest_metric && server.latest_metric.response_time) {
                responseTimeMetric.textContent = Math.round(server.latest_metric.response_time) + 'ms';
            }
        }
    });
}

function acknowledgeAlert(alertId) {
    fetch(`/api/alerts/${alertId}/acknowledge`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove the alert from the list
            const alertElement = document.querySelector(`[onclick="acknowledgeAlert(${alertId})"]`).closest('.list-group-item');
            alertElement.remove();
            
            // Check if no alerts remain
            const alertsList = document.getElementById('alerts-list');
            if (alertsList && alertsList.children.length === 0) {
                alertsList.innerHTML = `
                    <div class="text-center py-3">
                        <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                        <p class="text-muted mb-0">No active alerts</p>
                    </div>
                `;
            }
        }
    })
    .catch(error => {
        console.error('Error acknowledging alert:', error);
    });
}

// Interactive metric card functions
function showServersList() {
    fetch('/api/servers')
        .then(response => response.json())
        .then(servers => {
            const title = `All Servers (${servers.length})`;
            const content = generateServersListContent(servers);
            showMetricDetail(title, content);
        })
        .catch(error => {
            console.error('Error fetching servers:', error);
        });
}

function showOnlineServers() {
    fetch('/api/servers')
        .then(response => response.json())
        .then(servers => {
            const onlineServers = servers.filter(server => server.status === 'up');
            const title = `Online Servers (${onlineServers.length})`;
            const content = generateOnlineServersContent(onlineServers);
            showMetricDetail(title, content);
        })
        .catch(error => {
            console.error('Error fetching servers:', error);
        });
}

function showOfflineServers() {
    fetch('/api/servers')
        .then(response => response.json())
        .then(servers => {
            const offlineServers = servers.filter(server => server.status === 'down');
            const title = `Offline Servers (${offlineServers.length})`;
            const content = generateOfflineServersContent(offlineServers);
            showMetricDetail(title, content);
        })
        .catch(error => {
            console.error('Error fetching servers:', error);
        });
}

function showStreamsList() {
    fetch('/api/servers')
        .then(response => response.json())
        .then(servers => {
            // Collect all streams from all servers
            const allStreams = [];
            let totalConnections = 0;
            
            servers.forEach(server => {
                if (server.streams && server.streams.length > 0) {
                    server.streams.forEach(stream => {
                        stream.serverName = server.hostname;
                        stream.serverStatus = server.status;
                        totalConnections += stream.clients || 0;
                        allStreams.push(stream);
                    });
                }
            });
            
            const title = `All Streams - ${totalConnections} Total Connections`;
            const content = generateStreamsListContent(allStreams);
            showMetricDetail(title, content);
        })
        .catch(error => {
            console.error('Error fetching streams:', error);
        });
}

function generateServersListContent(servers) {
    if (servers.length === 0) {
        return '<p class="text-muted text-center">No servers configured</p>';
    }
    
    // Sort servers alphabetically
    servers.sort((a, b) => a.hostname.localeCompare(b.hostname));
    
    return servers.map(server => `
        <div class="server-list-item">
            <div class="server-item-header">
                <div class="server-item-name">${escapeHtml(server.hostname)}</div>
                <div class="server-item-status status-${server.status}">${server.status.toUpperCase()}</div>
            </div>
            <div class="server-item-details">
                <div class="detail-item">
                    <span class="detail-label">IP Address:</span>
                    <span class="detail-value">${escapeHtml(server.ip_address)}:${server.port}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Role:</span>
                    <span class="detail-value">${escapeHtml(server.role)}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">API Type:</span>
                    <span class="detail-value">${escapeHtml(server.api_type || 'N/A')}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Connections:</span>
                    <span class="detail-value">${server.latest_metric ? (server.latest_metric.active_connections || 0) : 0}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Streams:</span>
                    <span class="detail-value">${server.latest_metric ? (server.latest_metric.stream_count || 0) : 0}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Response Time:</span>
                    <span class="detail-value">${server.latest_metric && server.latest_metric.response_time ? Math.round(server.latest_metric.response_time) + 'ms' : 'N/A'}</span>
                </div>
            </div>
        </div>
    `).join('');
}

function generateOnlineServersContent(servers) {
    if (servers.length === 0) {
        return '<p class="text-muted text-center">No servers are currently online</p>';
    }
    
    // Sort servers alphabetically
    servers.sort((a, b) => a.hostname.localeCompare(b.hostname));
    
    return servers.map(server => `
        <div class="server-list-item">
            <div class="server-item-header">
                <div class="server-item-name">${escapeHtml(server.hostname)}</div>
                <div class="server-item-status status-up">ONLINE</div>
            </div>
            <div class="server-item-details">
                <div class="detail-item">
                    <span class="detail-label">CPU Usage:</span>
                    <span class="detail-value">${server.latest_metric && server.latest_metric.cpu_usage ? server.latest_metric.cpu_usage.toFixed(2) + '%' : 'N/A'}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Memory Usage:</span>
                    <span class="detail-value">${server.latest_metric && server.latest_metric.memory_usage ? server.latest_metric.memory_usage.toFixed(2) + '%' : 'N/A'}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Bandwidth In:</span>
                    <span class="detail-value">${server.latest_metric && server.latest_metric.bandwidth_in ? server.latest_metric.bandwidth_in.toFixed(2) + ' Mbps' : 'N/A'}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Bandwidth Out:</span>
                    <span class="detail-value">${server.latest_metric && server.latest_metric.bandwidth_out ? server.latest_metric.bandwidth_out.toFixed(2) + ' Mbps' : 'N/A'}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Active Connections:</span>
                    <span class="detail-value">${server.latest_metric ? (server.latest_metric.active_connections || 0) : 0}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Active Streams:</span>
                    <span class="detail-value">${server.latest_metric ? (server.latest_metric.stream_count || 0) : 0}</span>
                </div>
            </div>
        </div>
    `).join('');
}

function generateOfflineServersContent(servers) {
    if (servers.length === 0) {
        return '<p class="text-muted text-center">All servers are online</p>';
    }
    
    // Sort servers alphabetically
    servers.sort((a, b) => a.hostname.localeCompare(b.hostname));
    
    return servers.map(server => `
        <div class="server-list-item">
            <div class="server-item-header">
                <div class="server-item-name">${escapeHtml(server.hostname)}</div>
                <div class="server-item-status status-down">OFFLINE</div>
            </div>
            <div class="server-item-details">
                <div class="detail-item">
                    <span class="detail-label">IP Address:</span>
                    <span class="detail-value">${escapeHtml(server.ip_address)}:${server.port}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Role:</span>
                    <span class="detail-value">${escapeHtml(server.role)}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Last Response:</span>
                    <span class="detail-value">${server.latest_metric && server.latest_metric.timestamp ? formatDate(server.latest_metric.timestamp) : 'Never'}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Last Response Time:</span>
                    <span class="detail-value">${server.latest_metric && server.latest_metric.response_time ? Math.round(server.latest_metric.response_time) + 'ms' : 'N/A'}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Error Count:</span>
                    <span class="detail-value">${server.latest_metric ? (server.latest_metric.error_count || 0) : 0}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Status:</span>
                    <span class="detail-value">Connection Failed</span>
                </div>
            </div>
        </div>
    `).join('');
}

function generateStreamsListContent(streams) {
    if (streams.length === 0) {
        return '<p class="text-muted text-center">No active streams</p>';
    }
    
    // Sort streams alphabetically by name
    streams.sort((a, b) => a.name.localeCompare(b.name));
    
    return streams.map(stream => `
        <div class="stream-list-item">
            <div class="stream-item-header">
                <div class="stream-item-name">${escapeHtml(stream.name)}</div>
                <div class="stream-item-status status-up">LIVE</div>
            </div>
            <div class="stream-item-details">
                <div class="detail-item">
                    <span class="detail-label">Server:</span>
                    <span class="detail-value">${escapeHtml(stream.serverName)}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Clients:</span>
                    <span class="detail-value">${stream.clients || 0}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Receive Rate:</span>
                    <span class="detail-value">${stream.kbps && stream.kbps.recv_30s ? (stream.kbps.recv_30s / 1000).toFixed(2) + ' Mbps' : 'N/A'}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Send Rate:</span>
                    <span class="detail-value">${stream.kbps && stream.kbps.send_30s ? (stream.kbps.send_30s / 1000).toFixed(2) + ' Mbps' : 'N/A'}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Video:</span>
                    <span class="detail-value">${stream.video ? `${stream.video.width}x${stream.video.height} ${stream.video.codec}` : 'N/A'}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Uptime:</span>
                    <span class="detail-value">${stream.live_ms ? formatStreamUptime(stream.live_ms) : 'N/A'}</span>
                </div>
            </div>
        </div>
    `).join('');
}

function showMetricDetail(title, content) {
    document.getElementById('metric-detail-title').textContent = title;
    document.getElementById('metric-detail-body').innerHTML = content;
    document.getElementById('metric-detail-modal').style.display = 'flex';
}

function closeMetricDetail() {
    document.getElementById('metric-detail-modal').style.display = 'none';
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleString();
}

function formatStreamUptime(liveMs) {
    const now = Date.now();
    const uptimeMs = now - liveMs;
    const seconds = Math.floor(uptimeMs / 1000);
    const minutes = Math.floor(seconds / 60);
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);
    
    if (days > 0) {
        return `${days}d ${hours % 24}h ${minutes % 60}m`;
    } else if (hours > 0) {
        return `${hours}h ${minutes % 60}m`;
    } else if (minutes > 0) {
        return `${minutes}m ${seconds % 60}s`;
    } else {
        return `${seconds}s`;
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('metric-detail-modal');
    if (event.target === modal) {
        closeMetricDetail();
    }
});

// Close modal with Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeMetricDetail();
    }
});
</script>
{% endblock %}
